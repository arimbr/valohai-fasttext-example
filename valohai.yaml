---

- step:
    name: preprocess
    image: arimbr/valohai-fasttext-example
    command: python cli.py classification preprocess {parameters}
    inputs:
      - name: input_data
        default: s3://valohai-fasttext-example/toxic_comments/train.csv
    parameters:
     - name: output_preprocessed
       description: name of the output file (txt)
       type: string
       default: train.txt
     - name: feature
       description: feature column name
       type: string
       default: feature
     - name: category
       description: category column name
       type: string
       default: category
     - name: separator
       description: csv separator
       type: string
       default: ','


- step:
    name: autotune
    image: arimbr/valohai-fasttext-example
    command: python cli.py classification autotune {parameters}
    inputs:
      - name: train
        default: s3://valohai-fasttext-example/toxic_comments/train.txt
      - name: test
        default: s3://valohai-fasttext-example/toxic_comments/test.txt
    parameters:
     - name: metric
       description: metric objective {f1, f1:labelname} [f1]
       type: string
       default: f1
     - name: k
       description: number of predictions used for evaluation [1]
       type: integer
       default: 1
     - name: duration
       description: maximum duration in seconds [300]
       type: integer
       default: 300
     - name: model_size
       description: constraint model file size [] (empty = do not quantize)
       type: string
       default: ''

- step:
    name: test
    image: arimbr/valohai-fasttext-example
    command: python cli.py classification test {parameters}
    inputs:
      - name: test
        default: s3://valohai-fasttext-example/toxic_comments/test.txt
      - name: model
        default: s3://valohai-fasttext-example/toxic_comments/model.bin
    parameters:
     - name: k
       description: number of labels to predict [1]
       type: integer
       default: 1

- step:
    name: train
    image: arimbr/valohai-fasttext-example
    command: python cli.py classification train {parameters}
    inputs:
      - name: train
        default: s3://valohai-fasttext-example/toxic_comments/train.txt
      - name: test
        default: s3://valohai-fasttext-example/toxic_comments/test.txt
      - name: parameters
        default: s3://valohai-fasttext-example/toxic_comments/parameters.json

- pipeline:
    name: fasttext-pipeline
    nodes:
      - name: preprocess-train
        type: execution
        step: preprocess
      - name: preprocess-test
        type: execution
        step: preprocess
      - name: autotune
        type: execution
        step: autotune
      - name: test
        type: execution
        step: test
      - name: train
        type: execution
        step: train
    edges:
      - [preprocess-train.output.train.txt, autotune.input.train]
      - [preprocess-train.output.train.txt, train.input.train]
      - [preprocess-test.output.test.txt, autotune.input.test]
      - [preprocess-test.output.test.txt, train.input.test]
      - [preprocess-test.output.test.txt, test.input.test]
      - [autotune.output.model.bin, test.input.model]
      - [autotune.output.parameters.json, train.input.parameters]